<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.joonzis.mapper.ChatLogMapper">
	<insert id="insertChat" parameterType="org.joonzis.domain.ChatLogVO">
	    INSERT INTO GROUP_CHAT_LOG (
	        CHAT_NO, GROUP_NO, MEM_NO, CHAT_LOG, CHAT_TYPE, CHAT_TIME, CHAT_READ
	    ) VALUES (
	        CHAT_SEQ.NEXTVAL, #{groupNo}, #{memNo}, #{chatLog}, #{chatType}, SYSTIMESTAMP, 'N'
	    )
	</insert>
	
	<resultMap id="ChatLogMap" type="org.joonzis.domain.ChatLogVO">
	    <id property="chatNo" column="CHAT_NO"/>
	    <result property="groupNo" column="GROUP_NO"/>
	    <result property="memNo" column="MEM_NO"/>
	    <result property="chatLog" column="CHAT_LOG"/>
	    <result property="chatType" column="CHAT_TYPE"/>
	    <result property="chatRead" column="CHAT_READ"/>
	    <result property="chatTime" column="CHAT_TIME"/>
	</resultMap>
	
	<select id="getChatsByGroupNo" resultMap="ChatLogMap">
	    SELECT * FROM GROUP_CHAT_LOG WHERE GROUP_NO = #{groupNo}
	</select>
	
	<resultMap id="PrivateChatLogMap" type="org.joonzis.domain.PrivateChatLogVO">
	    <id property="chatNo" column="CHAT_NO"/>
	    <result property="roomNo" column="ROOM_NO"/>
	    <result property="senderNo" column="MEM_NO"/>
	    <result property="chatLog" column="CHAT_LOG"/>
	    <result property="chatTime" column="CHAT_TIME"/>
	</resultMap>
	
	<!-- 1:1 채팅방 생성 (방 존재 여부 확인 후) -->
    <select id="checkExistingRoom" resultType="int">
        SELECT ROOM_NO
        FROM PRIVATE_CHAT_ROOM
        WHERE (USER1_NO = #{user1No} AND USER2_NO = #{user2No})
           OR (USER1_NO = #{user2No} AND USER2_NO = #{user1No})
    </select>

    <insert id="createPrivateChatRoom">
        INSERT INTO PRIVATE_CHAT_ROOM (ROOM_NO, USER1_NO, USER2_NO)
        VALUES (#{roomNo}, #{user1No}, #{user2No})
    </insert>

    <!-- 채팅 내역 저장 -->
    <insert id="insertPrivateChatLog">
        INSERT INTO PRIVATE_CHAT_LOG (CHAT_NO, ROOM_NO, MEM_NO, CHAT_LOG, CHAT_TIME)
        VALUES (PRIVATE_CHAT_LOG_SEQ.NEXTVAL, #{roomNo}, #{senderNo}, #{chatLog}, SYSDATE)
    </insert>

    <!-- 1:1 채팅 내역 가져오기 -->
    <select id="getChatLogsByRoomNo" resultMap="PrivateChatLogMap">
        SELECT * FROM PRIVATE_CHAT_LOG
        WHERE ROOM_NO = #{roomNo}
        ORDER BY CHAT_TIME ASC
    </select>
    
    <select id="getMemberByNo" resultType="org.joonzis.domain.MemberVO">
		SELECT * FROM MEMBER WHERE MEM_NO = #{friendNo}
	</select>
</mapper>