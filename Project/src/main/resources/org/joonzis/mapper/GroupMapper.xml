<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.joonzis.mapper.GroupMapper">
	<insert id="createGroup" parameterType="org.joonzis.domain.GroupVO" useGeneratedKeys="true" keyProperty="groupNo">
		<selectKey keyProperty="groupNo" resultType="int" order="AFTER">
        	SELECT GROUP_SEQ.CURRVAL FROM DUAL
	    </selectKey>
		INSERT INTO "GROUP" (
			GROUP_NO, 
			MEM_NO, 
			CHAT_TITLE, 
			REG_DATE,
			MAX_MEM, 
			LIM_GENDER, 
			IS_PUBLIC,
			GROUP_MEMO,
			MIN_AGE,
			MAX_AGE
			)
		VALUES(
			GROUP_SEQ.NEXTVAL,
			#{memNo},
			#{chatTitle},
			sysdate,
			#{maxMem},
			#{limGender},
			#{isPublic, jdbcType=CHAR},
			#{groupMemo},
			#{minAge},
			#{maxAge}
		)
	</insert>
	
	<!-- 채팅방 생성 쿼리 -->
	<insert id="createChatRoom" parameterType="org.joonzis.domain.ChatRoomVO">
	    INSERT INTO GROUP_CHAT (
	    	GROUP_NO,
	    	REG_DATE
	    	)
	    VALUES (
	    	#{groupNo},
	    	sysdate
	    	)
	</insert>
	
	<!-- 채팅방 번호 가져오기 -->
	<resultMap id="groupResultMap" type="org.joonzis.domain.GroupVO">
	    <result property="groupNo" column="GROUP_NO"/>
	    <result property="chatTitle" column="CHAT_TITLE"/>
	</resultMap>

	<select id="getAllGroups" resultType="org.joonzis.domain.GroupMemberDTO">
	    SELECT
		    g.GROUP_NO,
		    g.CHAT_TITLE,
		    g.IS_PUBLIC,
		    m.MEM_NO,
		    m.GROUP_USERMEMO,
		    m.GROUP_BOOKMARK
		FROM
		    "GROUP" g
		INNER JOIN
		    GROUP_MEM m ON g.GROUP_NO = m.GROUP_NO
		WHERE
		    m.MEM_NO=#{mem_no}
		ORDER BY 
		    CASE 
		        WHEN m.GROUP_BOOKMARK = 'Y' THEN 1
		        WHEN m.GROUP_BOOKMARK = 'N' THEN 2
		        ELSE 3
		    END,
		    g.CHAT_TITLE ASC
	</select>
</mapper>